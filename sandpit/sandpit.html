<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8"/>
<title>Sand pit.</title>
<style>
canvas {
  border: 1px solid #000000;
  background-color: #fff0f0;
}
</style>
</head>
<body onload="start()">
<script>
"use strict";

function start() {
  // parameters of the game
  var sz = 5;  // better be odd.
  var width = 600;
  var height = 480;

  var field = newField(sz, width, height);
  field.start();
}

function newSand(field) {
  var sand = {
    field: field,
    x: Math.floor(field.width / 2) - Math.floor((field.sz+1)/2),
    y: 0,
    steps: field.steps,
    draw: function() {
      this._draw("#00e0ff");
    },
    clear: function() {
      this._draw("#fff0f0");
    },
    _draw: function(fill) {
      this.field.ctx.fillStyle = fill;
      this.field.ctx.fillRect(this.x, this.y, this.field.sz, this.field.sz);
    },
    newPos: function() {
      this.y += this.field.sz + 1;
      if (this.steps > 0) {
        this.steps -= 1;
        this.x += (Math.floor(Math.random()*2)*2-1) * 
            Math.floor((this.field.sz+1)/2);
      } else {
        if (this.y > this.field.height - 10) {
          return false;
        }
      }
      return true;
    }
  }
  return sand;
}

function tick(field) {
  field.tick();
}

function newField(sz, width, height) {
  var field = {
    sz: sz,
    width: width,
    height: height,
    fired: 0,
    steps: Math.floor(height * 0.7 / (sz+1)),
    canvas: document.createElement("canvas"),
    sands: [],
    start: function() {
      var i;
      this.canvas.width = this.width;
      this.canvas.height = this.height;
      this.ctx = this.canvas.getContext("2d");
      document.body.insertBefore(this.canvas, document.body.childNodes[0]);
      buildPegboard(this);
      this.interval = setInterval(tick, 50, this);
    },
    tick: function() {
      if (this.fired < 200) {
        if (this.sands.length === 0 ||
            this.sands[this.sands.length-1].steps < this.steps - 4) {
          // start a new sand
          this.sands.push(newSand(this));
          this.fired += 1;
        }
      } else if (this.sands.length === 0) {
        clearInterval(this.interval);
      }
      this.draw();
    },
    draw: function() {
      var i;
      var keep = [];
      for (i = 0; i < this.sands.length; i++) {
        this.sands[i].clear();
      }
      for (i = 0; i < this.sands.length; i++) {
        if (this.sands[i].newPos()) {
          keep.push(this.sands[i]);
        }
      }
      for (i = 0; i < this.sands.length; i++) {
        this.sands[i].draw();
      }
      this.sands = keep;
    }
  }
  return field;
}

function buildPegboard(field) {
  var i;
  var j;
  var n = 1;
  var starty = field.sz;
  var startx = Math.floor(field.width / 2);
  field.canvas.fillStyle = "#000000";
  for (i = 0; i < field.steps; i++) {
    for (j = 0; j < n; j++) {
      field.ctx.fillRect(startx + j*(field.sz+1), starty, 1, 1);
    }
    starty += field.sz + 1;
    startx -= Math.floor((field.sz+1)/2);
    n += 1;
  }
}
</script>
</body>
</html>
